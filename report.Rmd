---
title: "Investigating the relationship between wind and other weather variables."
author: "by Kate Supremacy: Connor, Kate, Ruth, Torgua & Kate"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load-lib, include = FALSE}
# add libraries for visualisation and modelling

library(tidyverse)
library(tidymodels)

```


```{r load-data, include=FALSE}
# import and clean data

nyweather <- read_csv("data/ny_weather.csv")

nyweather <- nyweather %>%
  rename(
    "date" = `DATE`,
    "cool_deg_hrs" = `HLY-CLDH-NORMAL`,
    "cloud_brkn_pct" = `HLY-CLOD-PCTBKN`,
    "cloud_clr_pct" = `HLY-CLOD-PCTCLR`,
    "cloud_few_pct" = `HLY-CLOD-PCTFEW`,
    "cloud_ovrcst_pct" = `HLY-CLOD-PCTOVC`,
    "cloud_scat_pct" = `HLY-CLOD-PCTSCT`,
    "dewp_10" = `HLY-DEWP-10PCTL`,
    "dewp_90" = `HLY-DEWP-90PCTL`,
    "dewp_avg" = `HLY-DEWP-NORMAL`,
    "heat_index_avg" = `HLY-HIDX-NORMAL`,
    "heat_deg_hrs" = `HLY-HTDH-NORMAL`,
    "pres_10pctl" = "HLY-PRES-10PCTL",
    "pres_90pctl" = "HLY-PRES-90PCTL",
    "pres_avg" = `HLY-PRES-NORMAL`,
    "temp_10pctl" = "HLY-TEMP-10PCTL",
    "temp_90pctl" = "HLY-TEMP-90PCTL",
    "temp_avg" = `HLY-TEMP-NORMAL`,
    "wind_chill_avg" = `HLY-WCHL-NORMAL`,
    "wind_main_dir" = "HLY-WIND-1STDIR",
    "wind_main_pct" = "HLY-WIND-1STPCT",
    "wind_2nd_dir" = "HLY-WIND-2NDDIR",
    "wind_2nd_pct" = "HLY-WIND-2NDPCT",
    "wind_spd_avg" = `HLY-WIND-AVGSPD`,
    "pct_calm" = `HLY-WIND-PCTCLM`,
    "wind_vector_dir" = `HLY-WIND-VCTDIR`,
    "wind_vector_spd" = `HLY-WIND-VCTSPD`
  ) %>% # rename columns
  select(-c("STATION", "NAME")) %>% # remove station and name
  separate(date, into = c("day", "time"), sep = "T") # separate date into day and time columns

nyweather[nyweather == -777.7] <- 0 # set values to 0 which would round to it

nyweather <- nyweather %>% 
  mutate(across(c(
    cloud_brkn_pct,cloud_clr_pct,cloud_few_pct,cloud_ovrcst_pct, cloud_scat_pct,
    wind_main_pct,wind_2nd_pct), ~ .x/10)) # divide percentages by 10

nyweather <- nyweather %>% 
  mutate(across(c(
    dewp_10, dewp_90, dewp_avg, heat_index_avg, temp_10pctl, temp_90pctl, temp_avg, wind_chill_avg),
    ~ signif((5/9)*(.x-32), 3))) # convert fahrenheit to celsius

```


## Research Question

Our research question is: Investigating the relationship between wind and other weather variables. We chose this focus because during our exploratory data analysis we noticed strong patterns and correlation between the wind chill and direction with other variables such as heat index and temperature.

## Data

Our dataset is from the National Centres for Environmental Information Climate Data, specifically the hourly normals for the city of New York in the year 2010, measured from JFK International Airport. These normals contain measurements of various meteorological parameters.

We selected this dataset because it had a large number of variables for each observation, therefore there should be some interesting correlations. The dataset also contained both numerical and categorical data so we could carry out a range of analyses on it.

The dataset came with documentation for all normals datasets, which explained the values in the dataset, special values and their meanings (which were necessary for cleaning) and how derived variables were calculated.

Our key variables we investigated are: wind_main_dir, wind_main_pct, wind_2nd_dir, wind_vector_dir, wind_spd_avg, wind_chill_avg, temp_avg, heat_index_avg, dewp_avg, cloud_scat_pct.


## Findings

### Methods

To import and clean our data we used tidyverse/dplyr functions in order to read a csv file as a dataframe, rename and transform columns. We continued to use this tool set in our exploratory data analysis: creating frequency tables and making summaries of different groups of data. Particularly we used a range of ggplot graph types to create bar charts, histograms, and scatter graphs, along with appropriately labelling the graphs and axes so it was clear what was being communicated in the visualisation. When working with dates we used the lubridate package and its functions. Then we went on to create models using the tidymodels package: creating training and testing dataframes, creating recipes, specifying models and combining these to form workflows which we then fitted to the training data to make predictions for the testing data. Following the creation of our models we then analysed their performance. For our logistic models this was done by plotting ROC curves and calculating the area underneath them to assess the fit of the model on the testing data. For linear regressions we calculated R-squared and RMSE, along with creating residual plots, in order to see how effectively a linear model fit the data.

### Exploratory Data Analysis

We began by creating some frequency tables of our key variables to understand them better.

```{r}
nyweather %>%
  count(wind_main_dir) %>%
  arrange(desc(n))

nyweather %>%
  count(wind_2nd_dir) %>%
  arrange(desc(n))
```
From this we can see that the most common wind directions are a northwest main direction and a west secondary direction, and the least common for both is east. 

We then created some bar charts to see how our key variables changed throughout the year.

```{r}
nyweather_separate <- nyweather %>% 
  separate(day, into = c("Month", "Day"), sep = "-") %>% 
  mutate(
    Month = as.numeric(Month),
    Day = as.numeric(Day),
    Name_Month = factor(month.abb[Month], levels = month.abb)
  )

nyweather_monthly <- nyweather_separate %>% 
  group_by(Name_Month) %>% 
  summarize(monthly_temp_avg = mean(temp_avg),
            monthly_dewp_avg = mean(dewp_avg),
            monthly_wind_chill_avg = mean(wind_chill_avg),
            monthly_wind_spd_avg = mean(wind_spd_avg))

nyweather_monthly %>% 
  ggplot(aes(x = Name_Month, y = monthly_temp_avg)) +
  geom_bar(stat = "identity") +
  labs(title = "Monthly Average Temperature",
       x="",
       y= "Temperature in deg C") +
  theme(axis.text.x = element_text(angle = 45))

nyweather_monthly %>% 
  ggplot(aes(x = Name_Month, y= monthly_wind_spd_avg)) +
  geom_bar(stat = "identity") +
  labs(title = "Monthly Average Wind Speed",
       x="",
       y= "Wind Speed in Mph") +
  theme(axis.text.x = element_text(angle = 45))

nyweather_monthly %>% 
ggplot(aes(x = Name_Month, y= monthly_dewp_avg))+
  geom_bar(stat = "identity") +
  labs(title = "Monthly Average Dew Point",
       x="",
       y= "Dew Point in deg C")+
  theme(axis.text.x = element_text(angle = 45))

nyweather_monthly %>% 
  ggplot(aes(x = Name_Month, y= monthly_wind_chill_avg)) +
  geom_bar(stat = "identity") +
  labs(title = "Monthly Average Wind Chill",
       x="",
       y= "Wind Chill in deg C") +
  theme(axis.text.x = element_text(angle = 45))
```

We also created some histograms to get a sense of the spread of our data values.

```{r}

nyweather %>% 
  ggplot(aes(wind_vector_dir))+
  geom_histogram(
    binwidth = 3
  )

```

The primary wind vector direction is left skewed, with the majority of values between 200-350 degrees which agrees with our frequency tables.  

```{r}

nyweather %>% 
  ggplot(aes(temp_avg))+
  geom_histogram(
    binwidth = 0.7
  )

nyweather %>% 
  ggplot(aes(heat_index_avg))+
  geom_histogram(
    binwidth = 1
  )

nyweather %>% 
  ggplot(aes(wind_chill_avg))+
  geom_histogram(
    binwidth = 1
  )

```

These histograms for temperature average, heat index average and wind chill average all have a similar shape, suggesting these variables are correlated which could help to answer our investigation question.  


Finally we made some scatterplots to assess correlation between certain variables before constructing our models.

```{r}
nyweather %>%
  ggplot(aes(x = cloud_scat_pct, y = dewp_avg)) +
  geom_point() +
  labs(title = "Dew Point Avg v Scattered Cloud Percentage")

nyweather %>%
  ggplot(aes(x = wind_chill_avg, y = heat_index_avg)) +
  geom_jitter() + 
  labs(title = "Heat Index Avg V Wind Chill Avg")

nyweather %>%
  ggplot(aes(x = wind_chill_avg, y = dewp_avg)) +
  geom_jitter() +
  labs(title = "Dew Point Avg v Wind Chill Avg")

```

### Linear regression
```{r}
set.seed(1234)
nyweather_split2 <- initial_split(nyweather)
nyweather_train2 <- training(nyweather_split2)
nyweather_test2  <- testing(nyweather_split2)

wind_heat_mod <- linear_reg() %>%
  set_engine("lm")

wind_heat_rec <- recipe(
  wind_chill_avg ~ heat_index_avg,
  data = nyweather_train2)

wind_heat_wflow <- workflow() %>%
  add_model(wind_heat_mod) %>%
  add_recipe(wind_heat_rec)

wind_heat_fit <- wind_heat_wflow %>%
  fit(data = nyweather_train2)

wind_heat_pred <- predict(wind_heat_fit, nyweather_test2) %>%
  bind_cols(nyweather_test2 %>% select(wind_chill_avg, heat_index_avg))

rsq(wind_heat_pred, truth = wind_chill_avg, estimate = .pred)
rmse(wind_heat_pred, truth = wind_chill_avg, estimate = .pred)

wind_heat_fit <- wind_heat_wflow %>%
  fit(data = nyweather_train2)
wind_heat_fit_tidy <- tidy(wind_heat_fit) 
wind_heat_fit_aug <- augment(wind_heat_fit, nyweather_train2) %>%
  mutate(res_cat = ifelse(.resid > 0, TRUE, FALSE))

ggplot(wind_heat_fit_aug, mapping = aes(x = .pred, y = .resid)) +
  geom_point(alpha = 0.4) + 
  geom_hline(yintercept = 0, 
             color = "blue", 
             lty = "dashed") +
  labs(title = "Residual Plot", 
       x = "Predicted Wind Chill", 
       y = "Residuals")
```
### Logistic regression
```{r}
nyweather <- nyweather %>%
  mutate(
    wind_main_west = case_when(
      wind_main_dir == "6" ~ "yes",
      wind_main_dir == "7" ~ "yes",
      wind_main_dir == "8" ~ "yes",
      TRUE ~ "no"
    ),
    wind_main_west = fct_relevel(wind_main_west, "no", "yes")
  )

set.seed(1234)
nyweather_split <- initial_split(nyweather)
nyweather_train <- training(nyweather_split)
nyweather_test  <- testing(nyweather_split) # Splitting data into training and testing.

wind_dir_rec_1 <- recipe(
  wind_main_west ~ temp_avg,
  data = nyweather_train)  # Created a recipe.

wind_dir_mod_1 <- logistic_reg() %>%
  set_engine("glm")     # Created a model.

wind_dir_wflow_1 <- workflow() %>%
  add_model(wind_dir_mod_1) %>%
  add_recipe(wind_dir_rec_1) #Added them to a work flow.

wind_dir_fit_1 <- wind_dir_wflow_1 %>%
  fit(data = nyweather_train)  # Applying work flow to training data.

tidy(wind_dir_fit_1)

wind_dir_pred_1 <- predict(wind_dir_fit_1, nyweather_test, type = "prob") %>%
  bind_cols(nyweather_test) 

wind_dir_pred_1

wind_dir_pred_1 %>%
  roc_curve(
    truth = wind_main_west,
    .pred_yes,             
    event_level = "second") %>%
  autoplot() # Plotting a ROC curve

wind_dir_pred_1 %>%
  roc_auc(
    truth = wind_main_west,
    .pred_yes,             
    event_level = "second"
  ) 

wind_dir_rec_2 <- recipe(
  wind_main_west ~ temp_avg + heat_index_avg + wind_chill_avg,
  data = nyweather_train  # Created a recipe.
)
wind_dir_rec_2 <- wind_dir_rec_2 %>%
  step_dummy(all_nominal(), -all_outcomes()) 
# Created dummy variables for all predictor variables and not of outcome variables.

wind_dir_mod_2 <- logistic_reg() %>%
  set_engine("glm")     # Created a model.

wind_dir_wflow_2 <- workflow() %>%
  add_model(wind_dir_mod_2) %>%
  add_recipe(wind_dir_rec_2) #Added them to a work flow.

wind_dir_fit_2 <- wind_dir_wflow_2 %>%
  fit(data = nyweather_train)  # Applying work flow to training data.

tidy(wind_dir_fit_2) 

wind_dir_pred_2 <- predict(wind_dir_fit_2, nyweather_test, type = "prob") %>% 
  bind_cols(nyweather_test) 
wind_dir_pred_2 # Using fitted model to predict the testing data.

wind_dir_pred_2 %>%
  roc_curve(
    truth = wind_main_west,
    .pred_yes,             
    event_level = "second") %>%
  autoplot() # Plotting a ROC curve

wind_dir_pred_2 %>%
  roc_auc(
    truth = wind_main_west,
    .pred_yes,             
    event_level = "second") 
```
### Answering our question

Investigating the relationships between wind and other weather variables has been a success as we have worked through key variables in the data set analysing as we went. Through this process we found variables that we could create models with and find relationships. We have established there is a clear relationship between westerly winds and cooler temperatures, upon further research this is due to winds coming from cold dry air in the west. 

Additionally while we did not find an appropriate model for the relationship between heat index and wind chill it was clear that a relationship did exist.

### Evaluation

WWW  
- We made clear and informative data visualisations, carried out several regressions and analysed the efficacy of these models.  
- We worked well as a team, splitting up the work equally and making sure that people were doing code/analysis techniques that they felt confident in. During workshops we also carried out pair programming techniques to reduce merger errors. When these did occur they were successfully resolved.  
- We coded clearly, using clear variable names and adding lots of comments to our code to explain what we were doing. We also worked in different R code chunks of the investigation.rmd document to clearly show the different sections of data analysis and also to reduce merger errors.  
- We clearly documented the progress of our project using a shared google document, recording notes of what we discussed at workshops and group meetings, making a note of our progress through the project criteria and recording sources we used.  

EBI  
- We could have looked into different cloud scatter patterns as part of our investigation and how these were affected by wind, and perhaps also looked into dew points more deeply.  
- We could have carried out cross validation to estimate how well the model would have worked in practice.  
- We could have extended our inferences from our modelling by using bootstrapping and constructing a confidence interval for predicting some sort of wind variable.  
- We could have added precipitation records from this time period to our data and analysed any correlation between this and wind (if we could have found different kinds of precipitation, for example distinguishing snow/rain/hail, this would have acted as an interesting categorical variable).


## References

Arguez, A., Durre, I., Applequist, S., Squires, M., Vose, R., Yin, X. and Bilotta, R. (2010). NOAA's U.S. Climate Normals (1981-2010): JFK International Airport, NY US, 2010. Available at: https://www.ncei.noaa.gov/access/metadata/landing-page/bin/iso?id=gov.noaa.ncdc:C00824 (Accessed 11 November 2024).

Pix4free (2016). Free New york city night cityscape Image. Available at: https://pix4free.org/assets/library/2021-01-12/originals/new_york_city_night_cityscape.jpg (Accessed 21 November 2024).

Pedersen, T.L. (n.d.) 'patchwork'. Available at: https://patchwork.data-imaginist.com/ (Accessed 23 November 2024)

